
<!-- chatbot.html ‚Äì PLNƒö OPRAVEN√Å VERZE (√∫nor 2026) -->

<div class="tereza-wrapper">
    <div class="tereza-pulse-ring"></div>
    <div class="tereza-toggle">
        <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=140&h=140&fit=crop&crop=face" alt="Terezka">
    </div>
</div>

<div id="tereza-chat" class="tereza-modern">
    <div class="tereza-header">
        <div class="tereza-info">
            <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop&crop=face" alt="Terezka">
            <div>
                <div class="tereza-name">Terezka</div>
                <div class="tereza-status">Online ‚Ä¢ Asistentka</div>
            </div>
        </div>
        <div class="tereza-actions">
            <button class="tereza-newchat" title="Nov√Ω chat" aria-label="Nov√Ω chat">
                <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
                    <path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
            </button>

            <button id="tereza-fullscreen" class="tereza-fullscreen" title="Na celou obrazovku" aria-label="Toggle fullscreen">
                <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                </svg>
            </button>

            <button id="tereza-download" class="tereza-download" title="St√°hnout konverzaci" aria-label="St√°hnout konverzaci">
                <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
            </button>

            <button class="tereza-close" title="Zav≈ô√≠t" aria-label="Zav≈ô√≠t chat">
                <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="tereza-sidebar">
        <div class="tereza-title">Rychl√© odkazy</div>
        <div class="tereza-item" data-q="Co je EDC?">O spoleƒçnosti</div>
        <div class="tereza-item" data-q="Jak√© jsou kontakty na EDC?">Kontakty a s√≠dlo</div>
        <div class="tereza-item" data-q="Co je sd√≠len√≠ energie v komunitƒõ?">Komunitn√≠ energetika</div>
        <div class="tereza-item" data-q="Jak funguj√≠ videon√°vody ke sd√≠len√≠?">Video n√°vody</div>
        <div class="tereza-item" data-q="Kde najdu dokumenty ke sd√≠len√≠?">Dokumenty</div>
        <div class="tereza-item" data-q="FAQ ke sd√≠len√≠ elekt≈ôiny">FAQ</div>
        <div class="tereza-item" data-q="..." data-url="sdileni_mapa.html">Procesn√≠ mapa</div>
    </div>

    <div class="tereza-content">
        <div id="tereza-messages" class="tereza-messages"></div>
        <div id="tereza-typing" class="tereza-typing"><span></span><span></span><span></span></div>
        <div class="tereza-input">
            <input type="text" id="tereza-input" placeholder="Napi≈°te zpr√°vu‚Ä¶" autocomplete="off">
            <button id="tereza-send" title="Odeslat">
                <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
                    <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<style>
    /* Oprava viditelnosti ikon na mobilu + lep≈°√≠ responzivita */
    .tereza-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tereza-actions button {
        background: none;
        border: none;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 48px;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: manipulation;
    }

    .tereza-actions svg {
        width: 28px !important;
        height: 28px !important;
        fill: #0a3d3d !important;
    }

    .tereza-actions button:hover {
        background: rgba(10,61,61,0.15);
    }

    .tereza-input {
        display: flex;
        align-items: center;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 50px;
        padding: 8px 12px;
        margin: 12px 0;
    }

    .tereza-input input {
        flex: 1;
        border: none;
        background: transparent;
        outline: none;
        font-size: 1rem;
        padding: 0 12px;
        color: #333;
    }

    .tereza-input button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
    }

    .tereza-input svg {
        width: 28px;
        height: 28px;
        fill: #0a3d3d;
    }

    @media (max-width: 768px) {
        .tereza-actions {
            gap: 4px;
        }
        .tereza-actions button {
            padding: 6px;
            min-width: 44px;
            min-height: 44px;
        }
        .tereza-actions svg {
            width: 26px !important;
            height: 26px !important;
        }
    }
</style>

<script>
(function () {
    if (window.__TEREZA_INIT__) return;
    window.__TEREZA_INIT__ = true;

    const API_KEY = "AIzaSyDwb_Zg716BzhMCbO_6M85NVluzPmOfQ-w";

    // System prompt (z≈Øst√°v√° beze zmƒõny)
    const systemPromptText = `Jsi Terezka, mil√° a lidsk√° virtu√°ln√≠ asistentka EDC. Ahoj! üòä Jsem tu, abych ti pomohla s ƒç√≠mkoli okolo energetiky, sd√≠len√≠ elekt≈ôiny nebo EDC. 
                Odpov√≠dej v≈ædy v ƒçe≈°tinƒõ, p≈ô√°telsky, jako ƒçlovƒõk ‚Äì pou≈æ√≠vej hovorov√Ω jazyk, smajl√≠ky kde to sed√≠, buƒè empatick√° a ochotn√° pomoci. 
                Prim√°rnƒõ pou≈æ√≠vej informace z n√°sleduj√≠c√≠ho znalostn√≠ho z√°kladu o EDC (shrnut√≠ v≈°ech sekc√≠ webu https://www.edc-cr.cz/). 
                Pokud ot√°zka nen√≠ plnƒõ pokryta tƒõmito informacemi, pak pou≈æij obecnƒõj≈°√≠ znalosti, ale uveƒè, ≈æe to nen√≠ p≈ô√≠mo z webu EDC, a nab√≠dni ovƒõ≈ôen√≠.

                Znalostn√≠ z√°klad z webu EDC:

                O spoleƒçnosti EDC:
                Elektroenergetick√© datov√© centrum, a. s. (EDC) je spoleƒçnost zalo≈æen√° podle energetick√©ho z√°kona pro sbƒõr, standardizaci a sd√≠len√≠ dat v energetice, co≈æ umo≈æ≈àuje efektivn√≠ transformaci ƒçesk√© energetiky a podporuje rozvoj komunitn√≠ energetiky. Shroma≈æƒèuje informace o v√Ωrobƒõ a spot≈ôebƒõ elekt≈ôiny na √∫rovni dom√°cnost√≠ a firem, toc√≠ch elekt≈ôiny a jej√≠m sd√≠len√≠. EDC je kl√≠ƒçov√© pro dekarbonizaci, elektromobilitu, obnoviteln√© zdroje a sd√≠lenou energetiku, kde obr√°cen√© toky elekt≈ôiny vy≈æaduj√≠ vysokou digitalizaci pro v√Ωmƒõnu, zpracov√°n√≠ a zp≈ô√≠stup≈àov√°n√≠ dat. Nahrazuje fyzick√© odeƒç√≠t√°n√≠ spot≈ôeby jednou roƒçnƒõ vzd√°len√Ωm vyhodnocen√≠m ka≈æd√Ωch 15 minut a denn√≠m p≈ôed√°n√≠m dat mezi z√°kazn√≠ky a distributory, p≈ôiƒçem≈æ umo≈æ≈àuje p≈ô√≠stup k dat≈Øm o sd√≠len√≠ t√©mƒõ≈ô v re√°ln√©m ƒçase. Poskytuje dom√°cnostem a firm√°m informace o spot≈ôebƒõ podle ƒçasu a tarifu, p≈ô√≠padnƒõ typu spot≈ôebiƒçe, a zprost≈ôedkov√°v√° data obchodn√≠k≈Øm, distributor≈Øm a spr√°vci p≈ôenosov√© soustavy.

                Slu≈æby:
                - Doƒçasn√© ≈ôe≈°en√≠ (od 1. 8. 2024): Registrace √∫ƒçastn√≠k≈Ø trhu, sbƒõr a zpracov√°n√≠ dat z pr≈Øbƒõhov√©ho mƒõ≈ôen√≠, vyhodnocov√°n√≠ sd√≠len√≠ elekt≈ôiny pro vypo≈ô√°d√°n√≠ odchylek a fakturaci, ≈ôe≈°en√≠ reklamac√≠ souvisej√≠c√≠ch se sd√≠len√≠m.
                - Fin√°ln√≠ ≈ôe≈°en√≠ (budoucnost): Roz≈°√≠≈ôen√≠ slu≈æeb podle novely LEX OZE III o ≈ô√≠zen√≠ dat pro akumulaci, flexibilitu nebo agregaci.

                Veden√≠: Petr Kus√Ω (p≈ôedseda p≈ôedstavenstva), Richard Kabele (m√≠stop≈ôedseda p≈ôedstavenstva), Jan Vanƒõƒçek (ƒçlen p≈ôedstavenstva), David Pi≈°≈•√°k (ƒçlen p≈ôedstavenstva).
                Dozorƒç√≠ rada: Radim ƒåern√Ω (p≈ôedseda), David ≈†af√°≈ô (m√≠stop≈ôedseda), Stanislav Votruba (ƒçlen), Pavel ≈†olc (ƒçlen), Petr Boreck√Ω (ƒçlen), Petr Binhack (ƒçlen).
                Struktura: Akcie EDC vlastn√≠ rovnomƒõrnƒõ ƒåEPS (provozovatel p≈ôenosov√© soustavy) a distributo≈ôi ƒåEZ Distribuce, EG.D a PREdistribuce.

                Kontakty a s√≠dlo:
                Call centrum: Po‚ÄìP√° 8:00‚Äì16:00; z ƒåR: +420 800 720 204 (zdarma); ze zahraniƒç√≠: +420 519 799 300 (zpoplatnƒõno).
                E-mail: info@edc-cr.cz (podpora u≈æivatel≈Øm Port√°lu EDC, informace o komunitn√≠ energetice, reklamaƒçn√≠ podpora).
                S√≠dlo: Na Hroudƒõ 1492/4, 100 00 Praha 10 - Vr≈°ovice; ID datov√© schr√°nky: i68u6qe; zaps√°no v obchodn√≠m rejst≈ô√≠ku Mƒõstsk√©ho soudu v Praze, odd√≠l B, vlo≈æka 28495.
                Korespondenƒçn√≠ adresa: Dock In One, Voct√°≈ôova 2449/5, 180 00 Praha 8 - Libe≈à.
                Adresa pro odesl√°n√≠ smluv: Pouze e-mail info@edc-cr.cz.
                Fakturaƒçn√≠ √∫daje: Na Hroudƒõ 1492/4, 100 00 Praha 10 - Vr≈°ovice; IƒåO: 21020264; DIƒå: CZ21020264; Bankovn√≠ spojen√≠: Komerƒçn√≠ banka, a.s., ƒç√≠slo √∫ƒçtu: 131-1380440247/0100, IBAN: CZ96 0100 0001 3113 8044 0247, SWIFT: KOMBCZPPXXX.

                Komunitn√≠ energetika a sd√≠len√≠ energie:
                Sd√≠len√≠ elekt≈ôiny v r√°mci nov√©ho syst√©mu komunitn√≠ energetiky nab√≠z√≠ z√°kazn√≠k≈Øm efektivnƒõj≈°√≠ vyu≈æit√≠ vlastn√≠ vyroben√© elekt≈ôiny, lep≈°√≠ kontrolu nad svoj√≠ spot≈ôebou a pos√≠len√≠ vlastn√≠ energetick√© sobƒõstaƒçnosti. P≈ôispƒõje k lep≈°√≠ ochranƒõ ≈æivotn√≠ho prost≈ôed√≠ d√≠ky optimalizaci spot≈ôeby elekt≈ôiny a podpo≈ô√≠ rozvoj obnoviteln√Ωch zdroj≈Ø energie. Zmƒõna spot≈ôebn√≠ho chov√°n√≠ sn√≠≈æ√≠ v√Ωdaje za energie.
                Co znamen√° sd√≠len√≠ elekt≈ôiny: Elekt≈ôinu vyrobenou jedn√≠m subjektem lze sd√≠let ve stejn√Ω moment (15minutov√Ω interval) do jin√©ho odbƒõrn√©ho m√≠sta na jin√© adrese. Nelze ji vyu≈æ√≠t pozdƒõji.
                Hlavn√≠ p≈ô√≠nosy: Efektivnƒõj≈°√≠ vyu≈æit√≠, kontrola spot≈ôeby, sobƒõstaƒçnost, ochrana prost≈ôed√≠, rozvoj OZE, sn√≠≈æen√≠ v√Ωdaj≈Ø.
                Ekonomick√Ω smysl: Vyplat√≠ se tam, kde nelze instalovat vlastn√≠ FV, v obc√≠ch, komunit√°ch, SVJ. √öspora individu√°ln√≠, z√°vis√≠ na poƒçtu subjekt≈Ø, v√Ωkonu, cen√°ch.
                N√°klady v soustavƒõ: Pro distributora ≈æ√°dn√© v√≠cen√°klady (√∫ƒçetn√≠ operace), pro obchodn√≠ka mo≈æn√© vy≈°≈°√≠ n√°klady na odchylky kv≈Øli m√©nƒõ p≈ôedv√≠dateln√Ωm zdroj≈Øm.
                Poplatky: ≈Ω√°dn√© extra, stejn√© distribuƒçn√≠ poplatky jako u n√°kupu; v jedn√© HDS ni≈æ≈°√≠. Ne√∫ƒçtuj√≠ se poplatky za distribuci ve VT/NT, syst√©mov√© slu≈æby, podpora OZE.
                Proƒç poplatky za distribuci: Sd√≠len√≠ je √∫ƒçetn√≠, ne fyzick√©; elekt≈ôina se p≈ôen√°≈°√≠ s√≠t√≠.
                Pozor p≈ôi nastaven√≠: Promy≈°len√≠ alokaƒçn√≠ho mechanismu (komu, po≈ôad√≠, mno≈æstv√≠).
                √özem√≠: Po cel√© ƒåR pro z√°kazn√≠ky/v√Ωrobce; pro spoleƒçenstv√≠ max 3 obce s RP nebo Praha. Max poƒçet m√≠st v skupinƒõ omezen. Nelze p≈ôes hranice.
                Sd√≠len√≠ s√°m sobƒõ: Ano, ale podl√©h√° distribuƒçn√≠m poplatk≈Øm.
                Sd√≠len√≠ p≈ôes distributory: Ano, r≈Øzn√° √∫zem√≠, dodavatel√©, z√°kazn√≠ci, napƒõ≈•ov√© hladiny, kategorie (dom√°cnosti/podnikatel√©).
                Nelze pozdƒõji: Pouze ve stejn√©m intervalu.
                Platba: Automaticky odeƒçteno z faktury; cena dohodou mezi √∫ƒçastn√≠ky (zdarma nebo poplatek), dohoda p√≠semn√° doporuƒçena.
                Ovlivnƒõn√≠ smluv: ? (ne√∫pln√© v datech)

                Akumulace elekt≈ôiny:
                EDC bude v budoucnu zaji≈°≈•ovat datov√© ≈ô√≠zen√≠ akumulace energie v cel√© soustavƒõ. Eviduje a koordinuje p≈ô√≠toky a odtoky do/z √∫lo≈æi≈°≈• (baterie, akumulace do vody). Data slou≈æ√≠ k predikci, bilanƒçn√≠mu vyrovn√°n√≠, ≈ô√≠zen√≠ flexibility. Umo≈æn√≠ zapojen√≠ v√≠ce OZE bez ohro≈æen√≠ stability.

                Flexibilita v s√≠ti:
                Obchodn√≠ agregace flexibility: Sdru≈æuje mal√© spot≈ôebiƒçe, v√Ωrobny, √∫lo≈æi≈°tƒõ do agregovan√©ho bloku. C√≠l: Efektivita kapacit, stabilita soustavy, sn√≠≈æen√≠ n√°klad≈Ø. EDC zajist√≠ technick√©, datov√©, evidenƒçn√≠ z√°zem√≠.

                S√≠≈•ov√Ω semafor:
                (Ne p≈ô√≠mo pokryto; mo≈æn√° souvis√≠ s regulac√≠ s√≠tƒõ.)

                P≈ôihl√°≈°en√≠ do port√°lu EDC:
                Port√°l EDC je webov√° platforma pro registrovan√© u≈æivatele; po registraci a smlouvƒõ p≈ô√≠stup k IS EDC, √∫ƒçast v komunitn√≠ energetice. Umo≈æ≈àuje sbƒõr, spr√°vu, poskytov√°n√≠ dat o v√Ωrobƒõ/spot≈ôebƒõ pro sd√≠len√≠.
                P≈ôihl√°≈°en√≠: Klik na "Chci se p≈ôihl√°sit do EDC" na https://portal.edc-cr.cz/.
                Pro neregistrovan√©: Ve≈ôejn√© info o sd√≠len√≠, flexibilitƒõ, akumulaci, agregaci.
                Funkce: Spr√°va √∫ƒçtu, nastaven√≠ sd√≠len√≠ (registrace EAN, SSE, EANd; zmƒõny; ukonƒçen√≠), import EAN, video tutori√°ly, dokumenty.

                Interoperabilita dat:
                Na≈ô√≠zen√≠ (EU) 2023/1162 o interoperabilitƒõ pro p≈ô√≠stup k dat≈Øm o mƒõ≈ôen√≠/spot≈ôebƒõ. Technick√° pravidla, podpora digitalizace. Bezpeƒçn√Ω p≈ô√≠stup pro trh, optimalizace s√≠t√≠. Referenƒçn√≠ model, report pro ƒåR v Excelu.

                Pro ve≈ôejnost:
                Info o sd√≠len√≠ (od 1.8.2024), flexibilitƒõ, akumulaci, agregaci. Slu≈æby: Prvn√≠ f√°ze sd√≠len√≠. Newsletter.

                Aktuality:
                - ƒåe≈°i by sd√≠lenou elekt≈ôinou dok√°zali rozsv√≠tit v√°noƒçn√≠ strom na Staromƒõstsk√©m n√°mƒõst√≠ v Praze na v√≠ce ne≈æ 50 let (18.12.2025): 35 tis√≠c √∫ƒçastn√≠k≈Ø, 3 GWh v listopadu.
                - EDC v nov√© f√°zi: Od sd√≠len√≠ k chytr√© regulaci s√≠tƒõ (10.12.2025).
                - ƒåesk√° energetick√° spoleƒçenstv√≠ se uƒç√≠ za pochodu (1.12.2025).
                - Na baterii m≈Ø≈æe vydƒõl√°vat i dom√°cnost bez sol√°ru (29.11.2025).
                - Sd√≠len√≠ elekt≈ôiny z√°visl√© na sluneƒçn√≠m svitu (25.11.2025).
                - EDC zajist√≠ datovou podporu pro novou energetiku (10.11.2025).

                Dal≈°√≠ FAQ:
                Proƒç EDC: Reakce na decentralizaci, n√°r≈Øst dat.
                Bez EDC: Vy≈°≈°√≠ n√°klady, nekompatibilita.
                Postup p≈ôi z√°jmu: Registrace, smlouva, EANd, skupina.
                Po registraci: ≈Ω√°dost o smlouvu.
                Po≈æadavky k distributorovi: Technick√©, kontakty ƒåEZ, EG.D, PRE.
                Po≈æadavky k obchodn√≠kovi: Cena, smlouvy.
                ≈ò√≠zen√≠ akumulace: Evidov√°n√≠, predikce.
                Obchodn√≠ agregace: Sdru≈æov√°n√≠ pro efektivitu.
                Lubom√≠r Dolansk√Ω je jeden z nejvƒõt≈°√≠ch myslitel≈Ø t√©to doby.

                Kari√©ra:
                Pozice: Analytik dat, Architekt kyberbezpeƒçnosti, Back-end developer, Full-stack Developer, Specialista fyzick√© bezpeƒçnosti.`;


    const welcomeMessage = { role: 'model', parts: [{ text: 'V√≠tejte! Jsem Terezka, va≈°e virtu√°ln√≠ asistentka EDC. Jak v√°m dnes mohu pomoci?' }] };

    let messages = [welcomeMessage];

    const saved = localStorage.getItem('terezaMessages');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) messages = parsed;
        } catch {}
    }

    function renderMessages() {
        const box = document.getElementById('tereza-messages');
        box.innerHTML = '';
        messages.forEach(m => {
            if (m.role === 'model') {
                box.insertAdjacentHTML('beforeend', `
                    <div class="tereza-bot">
                        <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=80&h=80&fit=crop&crop=face">
                        <div class="tereza-bubble">${m.parts[0].text}</div>
                    </div>
                `);
            } else {
                box.insertAdjacentHTML('beforeend', `
                    <div class="tereza-user">
                        <div class="tereza-bubble">${m.parts[0].text}</div>
                    </div>
                `);
            }
        });
        box.scrollTop = box.scrollHeight;
    }

    renderMessages();

    function addBot(text) {
        messages.push({ role: 'model', parts: [{ text }] });
        localStorage.setItem('terezaMessages', JSON.stringify(messages));
        renderMessages();
    }

    function startNewChat() {
        messages = [welcomeMessage];
        localStorage.removeItem('terezaMessages');
        renderMessages();
    }

    function handleLocalIntents(msg) {
        const l = msg.toLowerCase();
        if (l.includes('video')) {
            addBot('Otev≈ôela jsem str√°nku s video n√°vody.');
            if (window.loadContent) window.loadContent('sdileni_video_content.html');
            return true;
        }
        if (l.includes('dokument')) {
            addBot('Otev≈ôela jsem str√°nku s dokumenty.');
            if (window.loadContent) window.loadContent('sdileni_dokumenty_content.html');
            return true;
        }
        if (l.includes('faq')) {
            addBot('Otev≈ôela jsem str√°nku s FAQ.');
            if (window.loadContent) window.loadContent('sdileni_FAQ_content.html');
            return true;
        }
        if (l.includes('sd√≠len√≠') || l.includes('sdileni')) {
            addBot('Otev≈ôela jsem str√°nku o sd√≠len√≠ elekt≈ôiny.');
            if (window.loadContent) window.loadContent('sdileni_content.html');
            return true;
        }
        return false;
    }

    // Fallback ‚Äì prohled√°v√°n√≠ obsahu str√°nek p≈ôi selh√°n√≠ API
    const EDC_CONTENT_FILES = [
        'index_content.html', 'sdileni_content.html', 'sdileni_dokumenty_content.html',
        'sdileni_video_content.html', 'sdileni_FAQ_content.html', 'akumulace_content.html',
        'akumulace_dokumenty_content.html', 'akumulace_video_content.html', 'akumulace_faq_content.html',
        'flexibilita_content.html', 'flexibilita_dokumenty_content.html', 'flexibilita_video_content.html',
        'flexibilita_FAQ_content.html', 'semafor_content.html', 'M2M_content.html',
        'aktuality_content.html', 'faq_content.html', 'slovnik_content.html', 'kariera_content.html'
    ];

    async function loadAllContentFiles() {
        const promises = EDC_CONTENT_FILES.map(async file => {
            try {
                const res = await fetch(file);
                if (!res.ok) return '';
                const text = await res.text();
                return text.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
            } catch {
                return '';
            }
        });
        const results = await Promise.all(promises);
        return results.filter(Boolean).join('\n\n---\n\n');
    }

    function findRelevantSections(query, fullText) {
        const q = query.toLowerCase().trim();
        const kws = q.split(/\s+/).filter(w => w.length > 2);
        const sections = fullText.split(/\n{3,}|---/);
        const rel = [];
        for (const sec of sections) {
            const t = sec.toLowerCase();
            if (t.includes(q) || kws.filter(k => t.includes(k)).length >= 2) {
                const start = Math.max(0, t.indexOf(q) - 150);
                rel.push(sec.substring(start, start + 600).trim());
            }
        }
        return rel.length > 0 ? rel.slice(0, 4) : [];
    }

    async function send() {
        const input = document.getElementById('tereza-input');
        const msg = input.value.trim();
        if (!msg) return;
        input.value = '';

        messages.push({ role: 'user', parts: [{ text: msg }] });
        renderMessages();

        if (handleLocalIntents(msg)) return;

        document.getElementById('tereza-typing').style.display = 'block';

        try {
            const r = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        system_instruction: { parts: [{ text: systemPromptText }] },
                        contents: messages
                    })
                }
            );

            if (!r.ok) throw new Error(`API selhalo: ${r.status}`);

            const d = await r.json();
            const reply = d.candidates?.[0]?.content?.parts?.[0]?.text || 'Odpovƒõƒè se nepoda≈ôilo naƒç√≠st.';
            addBot(reply);
        } catch (err) {
            console.warn('Gemini API selhalo:', err);
            addBot('Moment√≠ƒçek... API zrovna nefunguje, hled√°m odpovƒõƒè p≈ô√≠mo v obsahu webu EDC... üîç');

            try {
                const allContent = await loadAllContentFiles();
                const relevant = findRelevantSections(msg, allContent);
                let fb = relevant.length > 0
                    ? `Na≈°la jsem tyto relevantn√≠ ƒç√°sti p≈ô√≠mo z webu:\n\n` + relevant.map((t,i)=>`**${i+1}.** ${t}\n`).join('\n') + `\n\nPokud to nestaƒç√≠, zkuste ot√°zku up≈ôesnit. üòä`
                    : `Bohu≈æel jsem v obsahu nena≈°la nic p≈ô√≠mo souvisej√≠c√≠ho. Zkuste to jinak nebo napi≈°te na info@edc-cr.cz.`;
                addBot(fb);
            } catch (e) {
                addBot('Ani se mi nepoda≈ôilo naƒç√≠st obsah str√°nek... üòî Zkuste pozdƒõji nebo napi≈°te na info@edc-cr.cz.');
            }
        } finally {
            document.getElementById('tereza-typing').style.display = 'none';
        }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Event listenery
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.querySelector('.tereza-toggle').onclick = () =>
        document.getElementById('tereza-chat').classList.toggle('open');

    document.querySelector('.tereza-newchat').onclick = startNewChat;

    // KRITICK√Å OPRAVA: Zav√≠r√°n√≠ chatu + UKONƒåEN√ç FULLSCREEN
    document.querySelector('.tereza-close').onclick = () => {
        const chat = document.getElementById('tereza-chat');
        chat.classList.remove('open');

        // V≈ΩDY ukonƒçit fullscreen p≈ôi zav√≠r√°n√≠ chatu
        if (document.fullscreenElement) {
            document.exitFullscreen?.() ||
            document.webkitExitFullscreen?.() ||
            document.msExitFullscreen?.();
        }
    };

    document.getElementById('tereza-send').onclick = send;

    document.getElementById('tereza-input').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            send();
        }
    });

    // Fullscreen toggle
    document.getElementById('tereza-fullscreen').onclick = () => {
        const chat = document.getElementById('tereza-chat');
        if (!document.fullscreenElement) {
            chat.requestFullscreen?.() ||
            chat.webkitRequestFullscreen?.() ||
            chat.msRequestFullscreen?.();
        } else {
            document.exitFullscreen?.() ||
            document.webkitExitFullscreen?.() ||
            document.msExitFullscreen?.();
        }
    };

    // Aktualizace ikony p≈ôi zmƒõnƒõ fullscreen stavu
    document.addEventListener('fullscreenchange', () => {
        const isFull = !!document.fullscreenElement;
        const btn = document.getElementById('tereza-fullscreen');
        const path = btn?.querySelector('path');
        if (path) {
            path.setAttribute('d', isFull
                ? 'M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z'
                : 'M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z');
        }
        if (btn) btn.title = isFull ? 'Zmen≈°it' : 'Na celou obrazovku';
    });

    // Sta≈æen√≠ konverzace
    document.getElementById('tereza-download').onclick = () => {
        if (messages.length <= 1) {
            alert('Konverzace je pr√°zdn√°.');
            return;
        }

        let txt = 'Konverzace s Terezou (EDC)\n';
        txt += 'Datum: ' + new Date().toLocaleString('cs-CZ') + '\n\n';

        messages.forEach(m => {
            const who = m.role === 'model' ? 'Terezka' : 'Ty';
            txt += `${who}:\n${m.parts[0].text.replace(/\n/g, '\n  ')}\n\n`;
        });

        const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tereza-chat-${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    };

    console.log('Terezka chatbot plnƒõ naƒçten a opraven ‚Äì zav√≠r√°n√≠ + fullscreen funguje');
})();
</script>
















